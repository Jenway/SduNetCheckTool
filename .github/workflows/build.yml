# Copyright (c) SduNetCheckTool
# Copyright (c) Microsoft Corporation.
# Licensed under the MIT license.

name: Build and Pack

on:
  push:
    branches:
      - master

jobs:
  build:
    strategy:
      matrix:
        targetplatform: [x64]
        Configuration: [Debug]
        ChannelName: [Prod_Store]

    runs-on: windows-latest

    env:
      appPackagesArchive: AppPackages.zip
      # appPackagesDirectory: bin\x64\${{ matrix.Configuration }}
      solutionPath: SduNetCheckTool.sln
      coreProjectDirectory: SduNetCheckTool.Core
      guiProjectDirectory: SduNetCheckTool.GUI
      coreProjectPath: SduNetCheckTool.Core\SduNetCheckTool.Core.csproj
      guiProjectPath: SduNetCheckTool.GUI\SduNetCheckTool.GUI.csproj
      Configuration: Debug
      appPackagesDirectory: bin\Debug


    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install .NET Core
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'

      - name: Setup MSBuild.exe
        uses: microsoft/setup-msbuild@v1.1

      - name: Restore the Wpf application
        run: msbuild ${{ env.solutionPath }} /t:Restore /p:Configuration=${{ matrix.Configuration }} /p:RuntimeIdentifier=win

      - name: Build wapproj
        run: msbuild ${{ env.solutionPath }} /p:Configuration=${{env.Configuration}} /p:UapAppxPackageBuildMode=StoreUpload /p:AppxBundle=Never /p:GenerateAppInstallerFile=False /p:AppxPackageSigningEnabled=False

      - name: Create archive
        run: |
          mkdir build
          Compress-Archive -Path ${{ env.guiProjectDirectory }}\${{ env.appPackagesDirectory }}\* -DestinationPath build\${{ env.appPackagesArchive }}
      
      - name: install node
        uses: actions/setup-node@v2
        with:
          node-version: '16.x'
      
      - name: Pack into single file executable
        run: | 
          cd .\.github\utils\
          npm install
          node pack.js
          cd -
      
      - name: 'Upload Artifact'
        uses: actions/upload-artifact@v3
        with:
          name: my-artifact
          path: |
            build/${{ env.appPackagesArchive }}
            build/SduNetCheckTool.GUI_boxed.exe
          retention-days: 5
